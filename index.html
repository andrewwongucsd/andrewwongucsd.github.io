<html>
  <meta charset="utf-8"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <!-- <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '182489696499776',
        xfbml      : true,
        version    : 'v6.0'
      });
      FB.AppEvents.logPageView();
    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script> -->
  <body><h1>It works!5646546</h1>
    <div id="clickLogin">
      <button onclick="myFunction()">Try it</button>
    </div>
  </body>
  <script>
  var myFunction = function(){
    oauthpopup({
      path: "https://api.instagram.com/oauth/authorize?client_id=2352475988187966&redirect_uri=https://andrewwongucsd.github.io/&scope=user_profile,user_media&response_type=code",
      callback: function(window){
          console.log('window is going to close.');
          console.log(window.location.href);
          console.log(window.location.host);
          console.log(window.location.hostname);
          window.close();
      }
  })}
  var oauthpopup = function(options){
      options.windowName = options.windowName ||  'ConnectWithOAuth'; // should not include space for IE
      options.windowOptions = options.windowOptions || 'location=0,status=0,width=800,height=400';
      options.callback = options.callback || function(){ window.location.reload(); };
      var that = this;

      that._oauthWindow = window.open(options.path, options.windowName, options.windowOptions);
      that._oauthInterval = window.setInterval(function(){
          if (that._oauthWindow != undefined && that._oauthWindow.closed) {
              window.clearInterval(that._oauthInterval);
              options.callback(that);
          }else{
            console.log("failed to close pop up window");
          }
      }, 1000);
    };
  function getQueryStringParameters(url){
      var urlParams={}, match, additional = /\+/g, // Regex for replacing additional symbol with a space
      search = /([^&=]+)=?([^&]*)/g,
      decode = function (s)
          { return decodeURIComponent(s.replace(additional, " ")); }, query;
          if (url){
            if(url.split("?").length>0){
              query = url.split("?")[1];
            }
          }else{
            url = window.location.href;
            query = window.location.search.substring(1);
          }
          while (match = search.exec(query)){
           urlParams[decode(match[1])] = decode(match[2]);
          }
          return urlParams;
  }

  function getAuthorizationCode(code){
  //   curl -X POST \
  // https://api.instagram.com/oauth/access_token \
  // -F client_id=684477648739411 \
  // -F client_secret=eb8c7... \
  // -F grant_type=authorization_code \
  // -F redirect_uri=https://socialsizzle.herokuapp.com/auth/ \
  // -F code=AQDp3TtBQQ...
    var url = "https://api.instagram.com/oauth/access_token";
    var payload = {
      client_id: "2352475988187966",
      client_secret: "96bee0c7579bb2e8776c2572f8e18e1a",
      grant_type: "authorization_code",
      redirect_uri: "https://andrewwongucsd.github.io/",
      code: code
    };
    $.post(url, payload, postGettingAuthorizationCode);
  }

  function postGettingAuthorizationCode(data, status){
    if(status == "success"){
      localStorage.setItem("access_token", data["access_token"]);
      localStorage.setItem("user_id", data["user_id"]);
      console.log("access_token and user_id set. "+data["access_token"]+", "+data["user_id"]);
    }else{
      console.log("failed to retrieve info");
    }
  }

      (function(){
        var code = getQueryStringParameters()["code"];
        console.log(code);
        if(code != undefined){
          var authorizationCode = getAuthorizationCode(code);

        }else{
          console.log("no code");
        }

      })();
    // (function(){
    //   oauthpopup({
    //     path: "https://api.instagram.com/oauth/authorize?client_id=182489696499776&redirect_uri=http://localhost&scope=user_profile,user_media&response_type=code",
    //     callback: function(){
    //         console.log('callback');
    //         //do callback stuff
    //     }
    // });
      // var loginbutton = document.getElementById("clickLogin");
      // loginbutton.style.cursor = 'pointer';
      // loginbutton.onclick = function(){
      //   var xhttp = new XMLHttpRequest();
      //   xhttp.onreadystatechange = function() {
      //     if (this.readyState == 4 && this.status == 200) {
      //       console.log(this.responseText);
      //      document.getElementById("clickLogin").innerHTML = this.responseText;
      //     }
      //   };
      //   var url = "https://api.instagram.com/oauth/authorize?client_id=182489696499776&redirect_uri=http://localhost&scope=user_profile,user_media&response_type=code";
      //   xhttp.open("GET", url, true);
      //   xhttp.send();
      // }
      // loginbutton.click = function(){
      //   var xhttp = new XMLHttpRequest();
      //   xhttp.onreadystatechange = function() {
      //     if (this.readyState == 4 && this.status == 200) {
      //      document.getElementById("clickLogin").innerHTML = this.responseText;
      //     }
      //   };
      //   var url = "https://api.instagram.com/oauth/authorize?client_id=182489696499776&redirect_uri=http://localhost&scope=user_profile,user_media&response_type=code";
      //   xhttp.open("GET", url, true);
      //   xhttp.send();
      // }
    // }());
  </script>
</html>
